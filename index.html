<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Global Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 50px;
  }
  .container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 400px;
  }
  input, button, textarea {
    width: 100%;
    padding: 8px;
    margin: 5px 0;
    box-sizing: border-box;
  }
  button {
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover { background-color: #0056b3; }
  .message { font-size: 0.9em; margin-top: 5px; }
  #chatBox { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 5px; margin-bottom: 10px; }
  .chatMessage { margin-bottom: 8px; }
  .chatMessage strong { color: #007bff; }
</style>
</head>
<body>

<!-- Login/Register -->
<div class="container" id="loginContainer">
  <h2>Login / Register</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
  <button id="googleBtn">Login with Google</button>
  <p id="loginMessage" class="message"></p>
</div>

<!-- Global Chat -->
<div class="container" id="chatContainer" style="display:none;">
  <h2 id="welcomeMsg"></h2>
  <div id="chatBox"></div>
  <textarea id="messageInput" placeholder="Type your message"></textarea>
  <button id="sendBtn">Send</button>
  <button id="logoutBtn">Logout</button>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  /* ===========================
     COOKIE FUNCTIONS
  ============================ */
  function setCookie(name, value, days) {
    const expires = days
      ? "; expires=" + new Date(Date.now() + days * 864e5).toUTCString()
      : "";
    document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
  }

  function getCookie(name) {
    return document.cookie
      .split("; ")
      .find(row => row.startsWith(name + "="))
      ?.split("=")[1];
  }

  function deleteCookie(name) {
    document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
  }

  function hash(str) {
    // Simple hash (not secure for production)
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0;
    }
    return hash.toString();
  }

  /* ===========================
     FIREBASE SETUP
  ============================ */
  const firebaseConfig = {
    apiKey: "AIzaSyAOmwkVoRJL98p6MrGyF7WjHjHQ84v8he4",
    authDomain: "messages-5d8fa.firebaseapp.com",
    projectId: "messages-5d8fa",
    storageBucket: "messages-5d8fa.appspot.com",
    messagingSenderId: "285093211755",
    appId: "1:285093211755:web:e45371038cf265769f0b2e",
    measurementId: "G-1XDBNNRKSD"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ===========================
     DOM ELEMENTS
  ============================ */
  const loginContainer = document.getElementById('loginContainer');
  const chatContainer = document.getElementById('chatContainer');
  const loginMessage = document.getElementById('loginMessage');
  const welcomeMsg = document.getElementById('welcomeMsg');
  const chatBox = document.getElementById('chatBox');
  const messageInput = document.getElementById('messageInput');

  /* ===========================
     AUTO-LOGIN USING COOKIES
  ============================ */
  const savedEmail = getCookie("email");
  const savedPasswordHash = getCookie("passwordHash");

  auth.onAuthStateChanged(user => {
    if (user) {
      showChat(user.email);
    } else if (savedEmail && savedPasswordHash) {
      // try auto-login with saved credentials
      const enteredPassword = prompt("Welcome back! Enter your password for " + savedEmail + ":");
      if (enteredPassword && hash(enteredPassword) === savedPasswordHash) {
        auth.signInWithEmailAndPassword(savedEmail, enteredPassword)
          .then(cred => showChat(cred.user.email))
          .catch(() => {});
      }
    }
  });

  /* ===========================
     LOGIN / REGISTER / GOOGLE
  ============================ */
  document.getElementById('loginBtn').addEventListener('click', () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, password)
      .then(cred => {
        setCookie("email", email, 365);
        setCookie("passwordHash", hash(password), 365);
        showChat(email);
      })
      .catch(e => loginMessage.textContent = e.message);
  });

  document.getElementById('registerBtn').addEventListener('click', () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    auth.createUserWithEmailAndPassword(email, password)
      .then(cred => {
        setCookie("email", email, 365);
        setCookie("passwordHash", hash(password), 365);
        showChat(email);
      })
      .catch(e => loginMessage.textContent = e.message);
  });

  document.getElementById('googleBtn').addEventListener('click', () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        setCookie("email", result.user.email, 365);
        deleteCookie("passwordHash");
        showChat(result.user.email);
      })
      .catch(e => loginMessage.textContent = e.message);
  });

  /* ===========================
     CHAT UI
  ============================ */
  function showChat(email) {
    loginContainer.style.display = 'none';
    chatContainer.style.display = 'block';
    welcomeMsg.textContent = `Welcome, ${email}!`;

    db.collection('messages').orderBy('timestamp')
      .onSnapshot(snapshot => {
        chatBox.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.classList.add('chatMessage');
          div.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text}`;
          chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
  }

  /* ===========================
     SEND MESSAGE
  ============================ */
  document.getElementById('sendBtn').addEventListener('click', () => {
    const text = messageInput.value.trim();
    const user = auth.currentUser;
    if (!text || !user) return;
    db.collection('messages').add({
      sender: user.email,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageInput.value = '';
  });

  /* ===========================
     LOGOUT
  ============================ */
  document.getElementById('logoutBtn').addEventListener('click', () => {
    auth.signOut().then(() => {
      deleteCookie("email");
      deleteCookie("passwordHash");
      chatContainer.style.display = 'none';
      loginContainer.style.display = 'block';
      loginMessage.textContent = '';
    });
  });
</script>
</body>
</html>
