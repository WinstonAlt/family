<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Global Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 50px;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 400px;
    }
    input, button, textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    .message { font-size: 0.9em; margin-top: 5px; }
    #chatBox { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 5px; margin-bottom: 10px; }
    .chatMessage { margin-bottom: 8px; }
    .chatMessage strong { color: #007bff; }
  </style>
</head>
<body>

<!-- Login/Register -->
<div class="container" id="loginContainer">
  <h2>Login / Register</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
  <button id="googleBtn">Login with Google</button>
  <p id="loginMessage" class="message"></p>
</div>

<!-- Global Chat -->
<div class="container" id="chatContainer" style="display:none;">
  <h2 id="welcomeMsg"></h2>
  <div id="chatBox"></div>
  <textarea id="messageInput" placeholder="Type your message"></textarea>
  <button id="sendBtn">Send</button>
  <button id="logoutBtn">Logout</button>
</div>

<script type="module">
  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAOmwkVoRJL98p6MrGyF7WjHjHQ84v8he4",
    authDomain: "messages-5d8fa.firebaseapp.com",
    projectId: "messages-5d8fa",
    storageBucket: "messages-5d8fa.firebasestorage.app",
    messagingSenderId: "285093211755",
    appId: "1:285093211755:web:e45371038cf265769f0b2e",
    measurementId: "G-1XDBNNRKSD"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM Elements
  const loginContainer = document.getElementById('loginContainer');
  const chatContainer = document.getElementById('chatContainer');
  const loginMessage = document.getElementById('loginMessage');
  const welcomeMsg = document.getElementById('welcomeMsg');
  const chatBox = document.getElementById('chatBox');
  const messageInput = document.getElementById('messageInput');

  // Login state listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      loginContainer.style.display = 'none';
      chatContainer.style.display = 'block';
      welcomeMsg.textContent = `Welcome, ${user.email || 'Guest'}!`;
      loadMessages();
    } else {
      loginContainer.style.display = 'block';
      chatContainer.style.display = 'none';
    }
  });

  // LOGIN / REGISTER
  document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      loginMessage.textContent = err.message;
    }
  });

  document.getElementById('registerBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    try {
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) {
      loginMessage.textContent = err.message;
    }
  });

  document.getElementById('googleBtn').addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      loginMessage.textContent = err.message;
    }
  });

  document.getElementById('guestBtn').addEventListener('click', async () => {
    try {
      await signInAnonymously(auth);
    } catch (err) {
      loginMessage.textContent = err.message;
    }
  });

  // LOGOUT
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth);
  });

  // LOAD MESSAGES
  function loadMessages() {
    const messagesRef = collection(db, "messages");
    const messagesQuery = query(messagesRef, orderBy("timestamp"));
    onSnapshot(messagesQuery, snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.classList.add('chatMessage');
        div.innerHTML = `<strong>${data.sender || 'Guest'}:</strong> ${data.text}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // SEND MESSAGE
  document.getElementById('sendBtn').addEventListener('click', async () => {
    const user = auth.currentUser;
    const text = messageInput.value.trim();
    if (!user || !text) return;

    // Worker URL (dynamic IP ban handled in Worker)
    const functionURL = "https://chat-worker.winstoncao06.workers.dev";

    try {
      const res = await fetch(functionURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sender: user.email || 'Guest',
          text
        })
      });

      const data = await res.json();
      if (!res.ok) {
        alert(data.error || "Failed to send message");
        return;
      }

      messageInput.value = "";
    } catch (err) {
      console.error(err);
      alert("Failed to send message");
    }
  });

</script>

</body>
</html>
